<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study-Bit ğŸ‡¨ğŸ‡±</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#04080f; --surface:#080f1a; --surface2:#0d1525;
  --border:#142030; --accent:#38bdf8; --accent2:#f97316;
  --accent3:#facc15; --green:#4ade80; --pink:#f472b6;
  --purple:#c084fc; --red:#f87171; --text:#c8dff0; --muted:#2a4060;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Share Tech Mono',monospace;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:2rem 1rem 3rem;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(56,189,248,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(56,189,248,.025) 1px,transparent 1px);background-size:36px 36px;pointer-events:none;z-index:0;}
body::after{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 55% 35% at 10% 5%,rgba(56,189,248,.06) 0%,transparent 60%),radial-gradient(ellipse 40% 45% at 90% 95%,rgba(250,204,21,.04) 0%,transparent 60%);pointer-events:none;z-index:0;}
.container{position:relative;z-index:1;max-width:720px;width:100%;}

/* SCREENS */
.screen{display:none;width:100%;flex-direction:column;align-items:center;}
.screen.active{display:flex;}

/* AUTH */
.auth-logo{font-family:'Orbitron',sans-serif;font-size:2.6rem;font-weight:900;color:var(--accent);text-shadow:0 0 30px rgba(56,189,248,.5);letter-spacing:.05em;margin-bottom:.3rem;text-align:center;}
.auth-sub{font-size:.6rem;color:var(--muted);letter-spacing:.2em;margin-bottom:2rem;text-align:center;}
.auth-card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:2rem;width:100%;max-width:440px;position:relative;}
.auth-card::before,.auth-card::after{content:'';position:absolute;width:14px;height:14px;border-color:var(--accent);border-style:solid;opacity:.4;}
.auth-card::before{top:8px;left:8px;border-width:2px 0 0 2px;}
.auth-card::after{bottom:8px;right:8px;border-width:0 2px 2px 0;}
.card-title{font-size:.6rem;color:var(--accent);letter-spacing:.2em;text-transform:uppercase;margin-bottom:1.4rem;border-bottom:1px solid var(--border);padding-bottom:.6rem;display:flex;align-items:center;gap:.5rem;}
.card-title::before{content:'â—ˆ';color:var(--accent2);font-size:.65rem;}
.field{margin-bottom:1rem;}
.field label{display:block;font-size:.58rem;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-bottom:.4rem;}
.field input,.field select{width:100%;background:rgba(0,0,0,.35);border:1px solid var(--border);border-radius:3px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.8rem;padding:.55rem .75rem;outline:none;transition:border-color .2s;}
.field input:focus,.field select:focus{border-color:rgba(56,189,248,.4);}
.field select option{background:#0d1525;}
.btn{width:100%;padding:.75rem;border:1px solid var(--accent);background:transparent;color:var(--accent);font-family:'Orbitron',sans-serif;font-size:.75rem;font-weight:700;letter-spacing:.12em;cursor:pointer;border-radius:4px;transition:all .2s;text-transform:uppercase;margin-top:.5rem;}
.btn:hover{background:rgba(56,189,248,.08);box-shadow:0 0 18px rgba(56,189,248,.2);}
.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn.danger{border-color:var(--red);color:var(--red);}
.btn.danger:hover{background:rgba(248,113,113,.08);}
.btn.green{border-color:var(--green);color:var(--green);}
.btn.green:hover{background:rgba(74,222,128,.08);}
.btn.sm{padding:.4rem .85rem;width:auto;font-size:.58rem;margin-top:0;}
.msg{font-size:.7rem;border:1px solid;border-radius:3px;padding:.5rem .8rem;margin-bottom:.8rem;display:none;}
.msg.error{color:var(--red);background:rgba(248,113,113,.07);border-color:rgba(248,113,113,.25);}
.msg.ok{color:var(--green);background:rgba(74,222,128,.07);border-color:rgba(74,222,128,.25);}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(56,189,248,.3);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;vertical-align:middle;margin-right:.3rem;}
@keyframes spin{to{transform:rotate(360deg);}}

/* SETUP */
.setup-box{background:rgba(249,115,22,.07);border:1px solid rgba(249,115,22,.3);border-radius:5px;padding:1.2rem 1.4rem;margin-bottom:1.2rem;width:100%;max-width:500px;font-size:.7rem;line-height:2;color:var(--accent2);}
.setup-box strong{display:block;color:var(--accent3);font-size:.75rem;margin-bottom:.4rem;}
.setup-box code{background:rgba(0,0,0,.4);padding:.1rem .4rem;border-radius:2px;font-size:.67rem;color:var(--text);}
pre.sql{background:rgba(0,0,0,.45);border:1px solid var(--border);border-radius:4px;padding:.8rem;font-size:.63rem;color:#7dd3fc;overflow-x:auto;margin:.5rem 0;line-height:1.6;}

/* ADMIN */
#adminScreen{max-width:660px;}
.admin-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;width:100%;flex-wrap:wrap;gap:.5rem;}
.admin-title{font-family:'Orbitron',sans-serif;font-size:1.1rem;color:var(--accent3);}
.users-table{width:100%;border-collapse:collapse;margin-bottom:1rem;}
.users-table th{font-size:.53rem;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;padding:.5rem .7rem;text-align:left;border-bottom:1px solid var(--border);}
.users-table td{font-size:.7rem;color:var(--text);padding:.55rem .7rem;border-bottom:1px solid rgba(20,32,48,.5);vertical-align:middle;}
.users-table tr:last-child td{border-bottom:none;}
.users-table tr:hover td{background:rgba(56,189,248,.03);}
.role-badge{font-size:.5rem;letter-spacing:.08em;text-transform:uppercase;border:1px solid;padding:.1rem .4rem;border-radius:100px;}
.role-admin{color:var(--accent2);border-color:rgba(249,115,22,.35);}
.role-user{color:var(--accent);border-color:rgba(56,189,248,.3);}
.stat-pill{font-size:.58rem;color:var(--green);background:rgba(74,222,128,.08);border:1px solid rgba(74,222,128,.2);border-radius:3px;padding:.1rem .45rem;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;margin-bottom:.8rem;}
@media(max-width:500px){.form-row{grid-template-columns:1fr;}}

/* APP TOPBAR */
.app-topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;width:100%;flex-wrap:wrap;gap:.5rem;}
.welcome-user{color:var(--accent);font-family:'Orbitron',sans-serif;font-size:.9rem;}
.topbar-sub{font-size:.53rem;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;}
.topbar-btns{display:flex;gap:.5rem;}

/* HEADER */
header{text-align:center;margin-bottom:1.5rem;width:100%;}
.header-tags{display:flex;gap:.4rem;justify-content:center;flex-wrap:wrap;margin-bottom:.7rem;}
.tag{font-size:.53rem;letter-spacing:.1em;text-transform:uppercase;border:1px solid;padding:.15rem .6rem;border-radius:100px;}
.tag-cl{color:var(--green);border-color:rgba(74,222,128,.3);}
.tag-chile{color:#ef4444;border-color:rgba(239,68,68,.3);}
.tag-mineduc{color:var(--accent3);border-color:rgba(250,204,21,.3);}
h1{font-family:'Orbitron',sans-serif;font-size:clamp(2rem,7vw,3.8rem);font-weight:900;color:var(--accent);text-shadow:0 0 30px rgba(56,189,248,.5);letter-spacing:.05em;}
.subtitle{font-size:.62rem;color:var(--muted);letter-spacing:.2em;margin-top:.3rem;}

/* PET */
.pet-stage{background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:2rem 1.5rem 1.8rem;margin-bottom:1rem;text-align:center;position:relative;overflow:hidden;}
.pet-stage .fml{position:absolute;font-size:.68rem;opacity:.055;color:var(--accent);pointer-events:none;user-select:none;}
.pet-stage::before,.pet-stage::after{content:'';position:absolute;width:16px;height:16px;border-color:var(--accent);border-style:solid;opacity:.4;}
.pet-stage::before{top:8px;left:8px;border-width:2px 0 0 2px;}
.pet-stage::after{bottom:8px;right:8px;border-width:0 2px 2px 0;}
.pet-wrap{position:relative;display:inline-block;margin-bottom:1rem;}
.pet-wrap::before{content:'';position:absolute;top:50%;left:50%;width:200px;height:200px;margin:-100px 0 0 -100px;border-radius:50%;border:1px solid rgba(56,189,248,.1);animation:pulse-ring 3s ease-out infinite;pointer-events:none;}
@keyframes pulse-ring{0%{transform:scale(.75);opacity:.7;}100%{transform:scale(1.4);opacity:0;}}
.pet-svg{width:165px;height:165px;cursor:pointer;filter:drop-shadow(0 0 18px rgba(56,189,248,.35));animation:float 4s ease-in-out infinite;transition:filter .3s;}
.pet-svg:hover{filter:drop-shadow(0 0 35px rgba(56,189,248,.7));}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-9px);}}
.pet-name{font-family:'Orbitron',sans-serif;font-size:1.5rem;font-weight:700;color:var(--accent);margin-bottom:.2rem;}
.pet-rank{font-size:.6rem;color:var(--accent3);letter-spacing:.18em;text-transform:uppercase;margin-bottom:.7rem;}
.thought-bubble{display:inline-block;font-size:.72rem;color:var(--text);background:rgba(56,189,248,.06);border:1px solid rgba(56,189,248,.18);border-radius:100px;padding:.35rem 1.1rem;margin-bottom:1.5rem;min-width:240px;max-width:100%;}
.thought-bubble::before{content:'ğŸ’­';margin-right:.4rem;}
.xp-row{display:flex;align-items:center;gap:.8rem;}
.xp-lbl{font-size:.6rem;color:var(--muted);white-space:nowrap;}
.xp-track{flex:1;height:10px;background:rgba(0,0,0,.5);border:1px solid var(--border);border-radius:2px;overflow:hidden;position:relative;}
.xp-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),#7dd3fc);box-shadow:0 0 12px rgba(56,189,248,.5);transition:width .8s cubic-bezier(.22,1,.36,1);}
.xp-track::after{content:'';position:absolute;inset:0;background-image:repeating-linear-gradient(90deg,transparent,transparent 14px,rgba(4,8,15,.5) 14px,rgba(4,8,15,.5) 15px);pointer-events:none;}
.xp-rval{font-size:.6rem;color:var(--accent);white-space:nowrap;}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.6rem;margin-bottom:1rem;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:.8rem .4rem;text-align:center;position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent);opacity:.3;}
.stat-icon{font-size:1.1rem;display:block;margin-bottom:.3rem;}
.stat-value{font-family:'Orbitron',sans-serif;font-size:1.05rem;font-weight:700;color:var(--accent);display:block;line-height:1;margin-bottom:.3rem;}
.stat-name{font-size:.52rem;color:var(--muted);letter-spacing:.07em;text-transform:uppercase;line-height:1.4;}

/* SUBJECTS */
.subject-section{background:var(--surface);border:1px solid var(--border);border-radius:5px;margin-bottom:1rem;overflow:hidden;}
.subject-tabs{display:flex;flex-wrap:wrap;border-bottom:1px solid var(--border);background:rgba(0,0,0,.3);}
.stab{flex:1 0 auto;padding:.5rem .55rem;font-size:.54rem;letter-spacing:.04em;cursor:pointer;border:none;background:transparent;color:var(--muted);font-family:'Share Tech Mono',monospace;border-bottom:2px solid transparent;transition:all .15s;text-align:center;white-space:nowrap;}
.stab:hover{color:var(--text);background:rgba(56,189,248,.04);}
.stab.active{color:var(--accent3);border-bottom-color:var(--accent3);}
.stab[data-s="len"].active{color:var(--pink);border-bottom-color:var(--pink);}
.stab[data-s="his"].active{color:#fb923c;border-bottom-color:#fb923c;}
.stab[data-s="bio"].active{color:var(--green);border-bottom-color:var(--green);}
.stab[data-s="qui"].active{color:var(--purple);border-bottom-color:var(--purple);}
.stab[data-s="fis"].active{color:var(--accent);border-bottom-color:var(--accent);}
.stab[data-s="cna"].active{color:#86efac;border-bottom-color:#86efac;}
.stab[data-s="ing"].active{color:#34d399;border-bottom-color:#34d399;}
.stab[data-s="fil"].active{color:#a78bfa;border-bottom-color:#a78bfa;}
.stab[data-s="art"].active{color:#fb7185;border-bottom-color:#fb7185;}
.stab[data-s="mus"].active{color:#f9a8d4;border-bottom-color:#f9a8d4;}
.stab[data-s="edf"].active{color:#86efac;border-bottom-color:#86efac;}
.stab[data-s="tec"].active{color:var(--accent3);border-bottom-color:var(--accent3);}
.subject-body{padding:1.2rem;}
.subject-header{display:flex;align-items:center;gap:.6rem;margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid var(--border);}
.subject-icon{font-size:1.3rem;}
.subject-name{font-family:'Orbitron',sans-serif;font-size:.85rem;font-weight:700;}
.subject-xp-today{margin-left:auto;font-size:.6rem;color:var(--green);}
.habits-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;}
@media(max-width:480px){.habits-grid{grid-template-columns:1fr;}}
.habit-item{border:1px solid var(--border);border-radius:4px;padding:.75rem;cursor:pointer;transition:all .15s;display:flex;align-items:flex-start;gap:.65rem;background:rgba(0,0,0,.2);user-select:none;}
.habit-item:hover{border-color:rgba(56,189,248,.3);background:rgba(56,189,248,.03);}
.habit-item.done{border-color:rgba(74,222,128,.4);background:rgba(74,222,128,.04);}
.habit-cb{width:17px;height:17px;border:1px solid var(--muted);border-radius:3px;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;font-size:.62rem;color:#000;transition:all .15s;}
.habit-item.done .habit-cb{background:var(--green);border-color:var(--green);}
.habit-body{flex:1;}
.habit-label{font-size:.7rem;color:var(--text);line-height:1.4;display:block;margin-bottom:.2rem;}
.habit-item.done .habit-label{color:var(--muted);text-decoration:line-through;}
.habit-xp{font-size:.57rem;color:var(--green);}

/* PANELS */
.panel{background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:1.2rem;margin-bottom:1rem;}
.panel-title{font-size:.57rem;color:var(--accent);letter-spacing:.2em;text-transform:uppercase;margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.6rem;}
.panel-title::before{content:'â—ˆ';color:var(--accent2);font-size:.6rem;}
.counter-row{display:flex;align-items:center;gap:1rem;}
.cbtn{padding:.5rem 1.1rem;border:1px solid var(--border);background:transparent;color:var(--text);font-size:1.1rem;cursor:pointer;border-radius:4px;transition:all .15s;font-family:'Share Tech Mono',monospace;}
.cbtn:hover{border-color:var(--accent);color:var(--accent);background:rgba(56,189,248,.07);}
.cbtn.plus{border-color:var(--green);color:var(--green);}
.cbtn.plus:hover{background:rgba(74,222,128,.07);}
.counter-mid{flex:1;text-align:center;}
.counter-num{font-family:'Orbitron',sans-serif;font-size:2.8rem;font-weight:900;color:var(--accent);line-height:1;}
.counter-lbl{font-size:.55rem;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-top:.2rem;}
.notes-area{background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:1.2rem;margin-bottom:1rem;}
.notes-input{width:100%;min-height:70px;background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:3px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.74rem;padding:.7rem;resize:vertical;outline:none;line-height:1.6;transition:border-color .2s;}
.notes-input::placeholder{color:var(--muted);}
.notes-input:focus{border-color:rgba(56,189,248,.35);}
.notes-save-btn{margin-top:.6rem;padding:.45rem 1rem;background:transparent;border:1px solid var(--accent);color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:.68rem;cursor:pointer;border-radius:3px;transition:all .15s;}
.notes-save-btn:hover{background:rgba(56,189,248,.08);}

/* LOG */
.study-log{background:#020508;border:1px solid var(--border);border-radius:5px;padding:1rem;font-size:.67rem;}
.log-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.7rem;padding-bottom:.5rem;border-bottom:1px solid var(--border);}
.log-header-title{font-size:.57rem;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;}
.log-xp{font-size:.57rem;color:var(--accent3);}
.log-line{display:flex;gap:.8rem;padding:.22rem 0;border-bottom:1px solid rgba(20,32,48,.5);}
.log-line:last-child{border-bottom:none;}
.log-t{color:#1a3040;flex-shrink:0;}
.log-m{color:#3a6080;}
.log-m.ok{color:var(--green);}
.log-m.evt{color:var(--accent3);}
.log-m.err{color:var(--red);}


/* LEADERBOARD */
.lb-panel{background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:1.2rem;margin-bottom:1rem;}
.lb-row{display:flex;align-items:center;gap:.8rem;padding:.6rem .5rem;border-bottom:1px solid rgba(20,32,48,.5);transition:background .15s;}
.lb-row:last-child{border-bottom:none;}
.lb-row:hover{background:rgba(56,189,248,.03);}
.lb-row.me{background:rgba(56,189,248,.06);border-radius:4px;}
.lb-pos{font-family:'Orbitron',sans-serif;font-size:.9rem;font-weight:700;width:28px;text-align:center;flex-shrink:0;}
.lb-pos.gold{color:#fbbf24;text-shadow:0 0 10px rgba(251,191,36,.5);}
.lb-pos.silver{color:#94a3b8;}
.lb-pos.bronze{color:#b45309;}
.lb-pos.rest{color:var(--muted);}
.lb-avatar{width:36px;height:36px;border-radius:50%;border:2px solid;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-family:'Orbitron',sans-serif;font-weight:700;flex-shrink:0;}
.lb-info{flex:1;}
.lb-name{font-size:.75rem;color:var(--text);display:block;}
.lb-rank-name{font-size:.56rem;color:var(--muted);}
.lb-xp{text-align:right;flex-shrink:0;}
.lb-xp-val{font-family:'Orbitron',sans-serif;font-size:.85rem;font-weight:700;display:block;}
.lb-streak{font-size:.55rem;color:var(--muted);}
.lb-empty{text-align:center;color:var(--muted);font-size:.7rem;padding:1.5rem;}

/* TOAST */
.toast{position:fixed;bottom:2rem;right:2rem;background:var(--surface2);border:1px solid var(--accent);border-left:3px solid var(--accent);padding:.8rem 1.2rem;font-size:.72rem;color:var(--accent);z-index:999;opacity:0;transform:translateX(20px);transition:all .25s;max-width:260px;border-radius:4px;}
.toast.show{opacity:1;transform:translateX(0);}
@keyframes evolve-anim{0%,100%{filter:drop-shadow(0 0 18px rgba(56,189,248,.35));}30%{filter:drop-shadow(0 0 70px rgba(255,255,255,.9));transform:scale(1.15) rotate(-4deg);}65%{filter:drop-shadow(0 0 50px rgba(250,204,21,.8));transform:scale(1.1) rotate(3deg);}}
.evolving .pet-svg{animation:evolve-anim 1.4s ease-in-out !important;}
</style>
</head>
<body>
<div class="container">

<!-- â•â•â•â•â•â• SETUP SCREEN â•â•â•â•â•â• -->
<div class="screen active" id="setupScreen">
  <div class="auth-logo">STUDY-BIT</div>
  <div class="auth-sub">// configuraciÃ³n de Supabase</div>
  <div class="setup-box">
    <strong>âš ï¸ Falta configurar Supabase</strong>
    Edita este archivo y reemplaza <code>TU_SUPABASE_URL</code> y <code>TU_SUPABASE_ANON_KEY</code><br>
    con los valores de tu proyecto. Sigue los pasos de abajo.
  </div>
  <div class="auth-card" style="max-width:520px;">
    <div class="card-title">Instrucciones â€” 5 minutos</div>
    <div style="font-size:.7rem;line-height:2.1;color:var(--text);">
      <b style="color:var(--accent3);">1.</b> Ve a <a href="https://supabase.com" target="_blank" style="color:var(--accent);">supabase.com</a> â†’ <b>Start your project</b><br>
      &nbsp;&nbsp;&nbsp;RegÃ­strate con tu email (sin 2FA obligatorio)<br>
      <b style="color:var(--accent3);">2.</b> Crea un nuevo proyecto â†’ ponle nombre (ej: <code>study-bit</code>)<br>
      &nbsp;&nbsp;&nbsp;Elige una contraseÃ±a para la base de datos â†’ <b>Create new project</b><br>
      <b style="color:var(--accent3);">3.</b> Espera ~1 min que se cree â†’ ve a <b>Project Settings â†’ API</b><br>
      &nbsp;&nbsp;&nbsp;Copia: <b>Project URL</b> y <b>anon / public key</b><br>
      <b style="color:var(--accent3);">4.</b> En el menÃº izquierdo ve a <b>SQL Editor</b> â†’ <b>New query</b><br>
      &nbsp;&nbsp;&nbsp;Pega y ejecuta este SQL:
      <pre class="sql">-- Tabla de usuarios
CREATE TABLE users (
  username   TEXT PRIMARY KEY,
  name       TEXT NOT NULL,
  password   TEXT NOT NULL,
  role       TEXT NOT NULL DEFAULT 'user',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Tabla de progreso
CREATE TABLE progress (
  username       TEXT PRIMARY KEY REFERENCES users(username) ON DELETE CASCADE,
  xp_total       INT DEFAULT 0,
  streak         INT DEFAULT 0,
  exercises_today INT DEFAULT 0,
  completed_today TEXT[] DEFAULT '{}',
  xp_today       INT DEFAULT 0,
  last_day       TEXT DEFAULT '',
  log            JSONB DEFAULT '[]',
  clicks         INT DEFAULT 0,
  notes          TEXT DEFAULT '',
  updated_at     TIMESTAMPTZ DEFAULT NOW()
);

-- Insertar admin por defecto
INSERT INTO users (username, name, password, role)
VALUES ('admin', 'Administrador', 'admin1234', 'admin')
ON CONFLICT DO NOTHING;

-- Desactivar RLS (fila segura) para acceso simple
ALTER TABLE users    DISABLE ROW LEVEL SECURITY;
ALTER TABLE progress DISABLE ROW LEVEL SECURITY;</pre>
      <b style="color:var(--accent3);">5.</b> Abre este <code>index.html</code> con un editor de texto<br>
      &nbsp;&nbsp;&nbsp;y reemplaza los dos valores marcados con <code>TU_SUPABASE_...</code><br>
      <b style="color:var(--accent3);">6.</b> Sube el archivo a GitHub Pages. Â¡Listo! âœ…
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• LOGIN â•â•â•â•â•â• -->
<div class="screen" id="loginScreen">
  <div class="auth-logo">STUDY-BIT</div>
  <div class="auth-sub">// ğŸ‡¨ğŸ‡± tu compaÃ±ero de colegio</div>
  <div class="auth-card">
    <div class="card-title">Iniciar sesiÃ³n</div>
    <div class="msg error" id="loginErr">Usuario o contraseÃ±a incorrectos.</div>
    <div class="field"><label>Usuario</label><input type="text" id="loginUser" placeholder="tu_usuario" autocomplete="off" onkeydown="if(event.key==='Enter')doLogin()"/></div>
    <div class="field"><label>ContraseÃ±a</label><input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()"/></div>
    <button class="btn" id="loginBtn" onclick="doLogin()">â–¶ ENTRAR</button>
  </div>
</div>

<!-- â•â•â•â•â•â• ADMIN â•â•â•â•â•â• -->
<div class="screen" id="adminScreen" style="max-width:660px;">
  <div class="admin-header">
    <div>
      <div class="admin-title">Panel de Admin</div>
      <div style="font-size:.55rem;color:var(--muted);margin-top:.2rem;letter-spacing:.1em;">STUDY-BIT ğŸ‡¨ğŸ‡± â€” Supabase</div>
    </div>
    <div style="display:flex;gap:.6rem;align-items:center;">
      <span class="role-badge role-admin">ADMIN</span>
      <button class="btn sm" onclick="showScreen('appScreen')">â† App</button>
      <button class="btn sm danger" onclick="doLogout()">Salir</button>
    </div>
  </div>

  <div class="auth-card" style="width:100%;margin-bottom:1rem;">
    <div class="card-title">Usuarios registrados</div>
    <div style="overflow-x:auto;">
      <table class="users-table">
        <thead><tr><th>Usuario</th><th>Nombre</th><th>Rol</th><th>XP</th><th>Racha</th><th>Acciones</th></tr></thead>
        <tbody id="usersBody"><tr><td colspan="6" style="text-align:center;color:var(--muted);padding:1rem;"><span class="spinner"></span> Cargando...</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="auth-card" style="width:100%;">
    <div class="card-title">Crear nuevo usuario</div>
    <div class="msg error" id="addErr"></div>
    <div class="msg ok"    id="addOk"></div>
    <div class="form-row">
      <div class="field" style="margin:0;"><label>Usuario (sin espacios)</label><input type="text" id="newUser" placeholder="juan123" autocomplete="off"/></div>
      <div class="field" style="margin:0;"><label>Nombre para mostrar</label><input type="text" id="newName" placeholder="Juan PÃ©rez"/></div>
    </div>
    <div class="form-row" style="margin-top:.8rem;">
      <div class="field" style="margin:0;"><label>ContraseÃ±a del nuevo usuario</label><input type="password" id="newPass" placeholder="mÃ­nimo 4 caracteres"/></div>
      <div class="field" style="margin:0;"><label>Rol</label>
        <select id="newRole" onchange="toggleMasterField()"><option value="user">Alumno</option><option value="admin">Admin</option></select>
      </div>
    </div>
    <!-- Campo contraseÃ±a maestra â€” solo visible al crear Admin -->
    <div id="masterField" style="display:none;margin-top:.8rem;">
      <div class="field" style="margin:0;background:rgba(249,115,22,.05);border:1px solid rgba(249,115,22,.25);border-radius:4px;padding:.8rem;">
        <label style="color:var(--accent2);">ğŸ” ContraseÃ±a maestra (requerida para crear admins)</label>
        <input type="password" id="masterPass" placeholder="Solo tÃº la sabes"/>
        <div style="font-size:.58rem;color:var(--muted);margin-top:.4rem;">Define esta clave en el cÃ³digo: busca <code>MASTER_PASSWORD</code></div>
      </div>
    </div>
    <button class="btn green" style="margin-top:1rem;" onclick="createUser()">+ CREAR USUARIO</button>
  </div>
</div>

<!-- â•â•â•â•â•â• APP â•â•â•â•â•â• -->
<div class="screen" id="appScreen">
  <div class="app-topbar">
    <div>
      <div class="topbar-sub">Bienvenido/a</div>
      <div class="welcome-user" id="welcomeUser">â€”</div>
    </div>
    <div class="topbar-btns">
      <button class="btn sm" id="adminBtn" style="display:none;" onclick="showScreen('adminScreen');loadUsers();">âš™ Admin</button>
      <button class="btn sm danger" onclick="doLogout()">Salir</button>
    </div>
  </div>

  <header>
    <div class="header-tags">
      <span class="tag tag-chile">ğŸ‡¨ğŸ‡± Chile</span>
      <span class="tag tag-cl">Clases presenciales</span>
      <span class="tag tag-mineduc">Plan Mineduc</span>
    </div>
    <h1>STUDY-BIT</h1>
    <div class="subtitle">// tu compaÃ±ero de colegio</div>
  </header>

  <!-- PET -->
  <div class="pet-stage">
    <span class="fml" style="top:12%;left:4%;transform:rotate(-7deg)">F = ma</span>
    <span class="fml" style="top:22%;right:3%;transform:rotate(6deg)">âˆ«f(x)dx</span>
    <span class="fml" style="bottom:18%;left:3%;transform:rotate(5deg)">E=mcÂ²</span>
    <span class="fml" style="bottom:8%;right:5%;transform:rotate(-6deg)">âˆ‡Â²Ï†=0</span>
    <span class="fml" style="top:50%;left:5%;transform:rotate(3deg)">vÂ²=vâ‚€Â²+2aÎ”x</span>
    <span class="fml" style="top:58%;right:4%;transform:rotate(-5deg)">dy/dx</span>
    <div class="pet-wrap" id="petWrap">
      <div id="petSvgContainer" style="width:165px;height:165px;cursor:pointer;" onclick="petClick()"></div>
    </div>
    <div class="pet-name">Study-Bit</div>
    <div class="pet-rank" id="petRank">// rango: Alumno Nuevo â€” nivel 1</div>
    <div class="thought-bubble" id="thoughtBubble">Ãbre tu cuaderno y empecemos...</div>
    <div class="xp-row">
      <span class="xp-lbl">XP</span>
      <div class="xp-track"><div class="xp-fill" id="xpFill" style="width:0%"></div></div>
      <span class="xp-rval" id="xpRight">0 / 150 XP</span>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-grid">
    <div class="stat-card"><span class="stat-icon">ğŸ”¥</span><span class="stat-value" id="s-streak">0</span><div class="stat-name">Racha dÃ­as</div></div>
    <div class="stat-card"><span class="stat-icon">ğŸ“</span><span class="stat-value" id="s-exercises">0</span><div class="stat-name">Ejercicios hoy</div></div>
    <div class="stat-card"><span class="stat-icon">âœ…</span><span class="stat-value" id="s-habits">0</span><div class="stat-name">HÃ¡bitos hoy</div></div>
    <div class="stat-card"><span class="stat-icon">âš¡</span><span class="stat-value" id="s-xp">0</span><div class="stat-name">XP total</div></div>
  </div>

  <!-- ASIGNATURAS -->
  <div class="subject-section">
    <div class="subject-tabs" id="subjectTabs"></div>
    <div class="subject-body" id="subjectBody"></div>
  </div>

  <!-- EJERCICIOS -->
  <div class="panel">
    <div class="panel-title">Ejercicios resueltos hoy</div>
    <div class="counter-row">
      <button class="cbtn" onclick="addExercise(-1)">âˆ’</button>
      <div class="counter-mid">
        <div class="counter-num" id="exCount">0</div>
        <div class="counter-lbl">ejercicios hoy (+5 XP c/u)</div>
      </div>
      <button class="cbtn plus" onclick="addExercise(1)">+</button>
    </div>
  </div>

  <!-- NOTES -->
  <div class="notes-area">
    <div class="panel-title">Apuntes / dudas del dÃ­a</div>
    <textarea class="notes-input" id="notesInput" placeholder="Â¿QuÃ© viste en clase hoy? Â¿QuÃ© duda tienes?"></textarea>
    <button class="notes-save-btn" onclick="saveNote()">ğŸ’¾ Guardar apunte (+10 XP)</button>
  </div>

  <!-- LOG -->
  <div class="study-log">
    <div class="log-header">
      <span class="log-header-title">Actividad</span>
      <span class="log-xp" id="logXpHoy">0 XP hoy</span>
    </div>
    <div id="logContainer"><div class="log-line"><span class="log-t">[ --:-- ]</span><span class="log-m">Study-Bit listo. Â¡Empieza tu primer hÃ¡bito!</span></div></div>

  <!-- LEADERBOARD -->
  <div class="lb-panel">
    <div class="panel-title">&#127942; Leaderboard &mdash; Tabla de honor</div>
    <div id="lbContainer"><div class="lb-empty"><span class="spinner"></span> Cargando...</div></div>
    <div style="text-align:right;margin-top:.6rem;">
      <button class="notes-save-btn" onclick="loadLeaderboard()">&#8635; Actualizar</button>
    </div>
  </div>

</div>
</div><!-- /container -->
<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â–¼â–¼â–¼  PEGA AQUÃ TUS CREDENCIALES  â–¼â–¼â–¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SUPABASE_URL      = 'https://rgrapjcdwmrbmrvbhenx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJncmFwamNkd21yYm1ydmJoZW54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTE0MjMsImV4cCI6MjA4Nzc2NzQyM30.qPP-EueVVjY8ub_wA1SO74wNaqB9mULbAvsX8qFuuTc';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â–²â–²â–²  FIN CREDENCIALES  â–²â–²â–²
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const CONFIGURED = !SUPABASE_URL.startsWith('TU_');

/* â”€â”€ Supabase REST helper â”€â”€ */
async function sb(method, table, opts = {}) {
  const { filter, body, select, single } = opts;
  let url = `${SUPABASE_URL}/rest/v1/${table}`;
  const params = [];
  if (select)          params.push(`select=${select}`);
  if (filter)          params.push(filter);
  if (single)          params.push('limit=1');
  if (params.length)   url += '?' + params.join('&');

  const headers = {
    'apikey':        SUPABASE_ANON_KEY,
    'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
    'Content-Type':  'application/json',
    'Prefer':        single ? 'return=representation' : 'return=representation',
  };

  const res = await fetch(url, {
    method,
    headers,
    body: body ? JSON.stringify(body) : undefined,
  });

  if (!res.ok) {
    const err = await res.text();
    throw new Error(err);
  }

  const text = await res.text();
  if (!text) return null;
  const data = JSON.parse(text);
  return single ? (Array.isArray(data) ? data[0] : data) : data;
}

/* Upsert helper */
async function sbUpsert(table, body) {
  const url = `${SUPABASE_URL}/rest/v1/${table}`;
  const res = await fetch(url, {
    method: 'POST',
    headers: {
      'apikey':        SUPABASE_ANON_KEY,
      'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
      'Content-Type':  'application/json',
      'Prefer':        'resolution=merge-duplicates,return=representation',
    },
    body: JSON.stringify(body),
  });
  if (!res.ok) throw new Error(await res.text());
  return JSON.parse(await res.text());
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SUBJECTS = [
  {id:'mat',label:'Mat', name:'MatemÃ¡tica',   icon:'ğŸ“',col:'#38bdf8',habits:[
    {id:'mat1',label:'ResolvÃ­ ejercicios del libro/guÃ­a',xp:20},
    {id:'mat2',label:'EntendÃ­ el procedimiento, no solo el resultado',xp:25},
    {id:'mat3',label:'RepasÃ© la materia antes de la clase',xp:15},
    {id:'mat4',label:'CorregÃ­ errores de una prueba o guÃ­a',xp:25}]},
  {id:'len',label:'Len', name:'Lenguaje',      icon:'ğŸ“–',col:'#f472b6',habits:[
    {id:'len1',label:'LeÃ­ el texto asignado completo',xp:20},
    {id:'len2',label:'Hice anÃ¡lisis literario o comentario de texto',xp:25},
    {id:'len3',label:'RedactÃ© o corregÃ­ un texto escrito',xp:20},
    {id:'len4',label:'RepasÃ© ortografÃ­a y gramÃ¡tica',xp:15}]},
  {id:'his',label:'His', name:'Historia',      icon:'ğŸ—ºï¸',col:'#fb923c',habits:[
    {id:'his1',label:'LeÃ­ los contenidos de la unidad',xp:20},
    {id:'his2',label:'Hice lÃ­nea de tiempo o mapa conceptual',xp:20},
    {id:'his3',label:'RespondÃ­ preguntas de desarrollo',xp:25},
    {id:'his4',label:'AnalicÃ© una fuente histÃ³rica o documento',xp:25}]},
  {id:'bio',label:'Bio', name:'BiologÃ­a',      icon:'ğŸ”¬',col:'#4ade80',habits:[
    {id:'bio1',label:'EstudiÃ© los conceptos clave del tema',xp:20},
    {id:'bio2',label:'DibujÃ© o identifiquÃ© estructuras / organelas',xp:20},
    {id:'bio3',label:'RespondÃ­ preguntas de la guÃ­a',xp:20},
    {id:'bio4',label:'ExpliquÃ© el proceso con mis palabras',xp:25}]},
  {id:'qui',label:'Qui', name:'QuÃ­mica',       icon:'âš—ï¸',col:'#c084fc',habits:[
    {id:'qui1',label:'ResolvÃ­ ejercicios de estequiometrÃ­a o mol',xp:25},
    {id:'qui2',label:'BalanceÃ© reacciones quÃ­micas',xp:20},
    {id:'qui3',label:'EstudiÃ© tabla periÃ³dica y propiedades',xp:15},
    {id:'qui4',label:'EntendÃ­ el mecanismo de la reacciÃ³n',xp:25}]},
  {id:'fis',label:'FÃ­s', name:'FÃ­sica',        icon:'ğŸ”­',col:'#38bdf8',habits:[
    {id:'fis1',label:'ResolvÃ­ problemas con fÃ³rmulas aplicadas',xp:25},
    {id:'fis2',label:'DibujÃ© diagrama de cuerpo libre o sistema',xp:20},
    {id:'fis3',label:'EntendÃ­ el concepto detrÃ¡s del ejercicio',xp:25},
    {id:'fis4',label:'VerifiquÃ© unidades (anÃ¡lisis dimensional)',xp:15}]},
  {id:'cna',label:'C.Nat',name:'Cs. Naturales',icon:'ğŸŒ¿',col:'#86efac',habits:[
    {id:'cna1',label:'EstudiÃ© conceptos del ecosistema o ambiente',xp:20},
    {id:'cna2',label:'RelacionÃ© contenido con situaciones reales',xp:20},
    {id:'cna3',label:'RespondÃ­ guÃ­a o actividad del ramo',xp:20},
    {id:'cna4',label:'Hice esquema o resumen del tema',xp:15}]},
  {id:'ing',label:'Ing', name:'InglÃ©s',        icon:'ğŸŒ',col:'#34d399',habits:[
    {id:'ing1',label:'AprendÃ­ vocabulario nuevo (10+ palabras)',xp:15},
    {id:'ing2',label:'PractiquÃ© gramÃ¡tica (tenses / estructura)',xp:20},
    {id:'ing3',label:'LeÃ­ o escuchÃ© texto en inglÃ©s',xp:20},
    {id:'ing4',label:'EscribÃ­ un pÃ¡rrafo en inglÃ©s',xp:25}]},
  {id:'fil',label:'Fil', name:'FilosofÃ­a',     icon:'ğŸ§ ',col:'#a78bfa',habits:[
    {id:'fil1',label:'LeÃ­ el texto filosÃ³fico asignado',xp:20},
    {id:'fil2',label:'FormulÃ© un argumento propio con evidencia',xp:25},
    {id:'fil3',label:'IdentifiquÃ© falacias o errores lÃ³gicos',xp:20},
    {id:'fil4',label:'ComparÃ© posturas de distintos filÃ³sofos',xp:20}]},
  {id:'art',label:'Art', name:'Artes Vis.',    icon:'ğŸ¨',col:'#fb7185',habits:[
    {id:'art1',label:'TrabajÃ© en mi obra o proyecto artÃ­stico',xp:20},
    {id:'art2',label:'EstudiÃ© tÃ©cnica o corriente artÃ­stica',xp:15},
    {id:'art3',label:'AnalicÃ© obra de un artista o movimiento',xp:20},
    {id:'art4',label:'EsbocÃ© ideas para la prÃ³xima tarea',xp:15}]},
  {id:'mus',label:'MÃºs', name:'MÃºsica',        icon:'ğŸµ',col:'#f9a8d4',habits:[
    {id:'mus1',label:'PractiquÃ© instrumento o voz (20+ min)',xp:20},
    {id:'mus2',label:'EstudiÃ© teorÃ­a musical o lectura de partituras',xp:15},
    {id:'mus3',label:'AnalicÃ© una obra musical asignada',xp:20},
    {id:'mus4',label:'EnsayÃ© con el grupo o ensamble',xp:25}]},
  {id:'edf',label:'Ed.F',name:'Ed. FÃ­sica',    icon:'âš½',col:'#86efac',habits:[
    {id:'edf1',label:'RealicÃ© actividad fÃ­sica (30+ min)',xp:20},
    {id:'edf2',label:'EstudiÃ© reglamento o tÃ¡ctica deportiva',xp:15},
    {id:'edf3',label:'PractiquÃ© habilidad motriz especÃ­fica',xp:20},
    {id:'edf4',label:'CompletÃ© tarea teÃ³rica del ramo',xp:15}]},
  {id:'tec',label:'Tec', name:'TecnologÃ­a',    icon:'ğŸ’»',col:'#facc15',habits:[
    {id:'tec1',label:'AvancÃ© en el proyecto o prototipo',xp:25},
    {id:'tec2',label:'AprendÃ­ herramienta o software nuevo',xp:20},
    {id:'tec3',label:'DocumentÃ© el proceso de diseÃ±o',xp:15},
    {id:'tec4',label:'ProbÃ© y corregÃ­ errores del proyecto',xp:20}]},
];

const LEVELS=[
  {min:0,    max:150,  name:'Alumno Nuevo',             col:'#38bdf8', shape:'bean'},
  {min:150,  max:400,  name:'Estudiante Constante',     col:'#60d0fa', shape:'round'},
  {min:400,  max:750,  name:'Aplicado de Verdad',       col:'#facc15', shape:'book'},
  {min:750,  max:1200, name:'Crack del Curso',           col:'#fb923c', shape:'star'},
  {min:1200, max:1800, name:'Honor Roll ğŸ…',     col:'#f472b6', shape:'wizard'},
  {min:1800, max:2600, name:'Leyenda del Colegio ğŸ“', col:'#4ade80', shape:'robot'},
  {min:2600, max:3600, name:'Maestro PAES âš¡',       col:'#a78bfa', shape:'lightning'},
  {min:3600, max:5000, name:'Genio Absoluto ğŸ§¬',  col:'#34d399', shape:'dna'},
  {min:5000, max:7000, name:'Semidios Academico ğŸ”±', col:'#fbbf24', shape:'god'},
  {min:7000, max:99999,name:'SINGULARIDAD ğŸŒŒ',   col:'#ffffff', shape:'singularity'},
];
const THOUGHTS=[
  'Ãbre tu cuaderno y empecemos...','Â¡Un hÃ¡bito completado! ğŸ’ª',
  'La constancia gana a la velocidad.','Repasa los apuntes antes de dormir.',
  'Â¿Ya hiciste los ejercicios de hoy?','Explica lo que aprendiste, si puedes lo entendiste.',
  'Ya ves los patrones entre ramos ğŸ”¬','Â¡Eres una leyenda del colegio!',
  'El nivel PAES ya no te asusta âš¡','La SINGULARIDAD se acerca... ğŸŒŒ',
];
const CLICK_MSGS=['Â¿Ya hiciste los ejercicios del dÃ­a?','Toma agua. El cerebro lo agradece.','Â¿Revisaste los errores de la Ãºltima prueba?','Un concepto entendido vale diez memorizados.','Â¿CuÃ¡ndo es el prÃ³ximo examen? ğŸ‘€','Pregunta en clases. No hay preguntas malas.','DesconÃ©ctate 5 min, vuelves mÃ¡s fuerte.','La PAES se construye dÃ­a a dÃ­a.'];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let session    = null;   // {username, name, role}
let appState   = {};
let activeSubj = SUBJECTS[0].id;
let saveTimer  = null;

const emptyState = () => ({
  xp_total:0, streak:0, exercises_today:0,
  completed_today:[], xp_today:0, last_day:'',
  log:[], clicks:0, notes:'',
});

/* session persisted in sessionStorage */
function getSession(){ try{return JSON.parse(sessionStorage.getItem('sb_s')||'null');}catch(e){return null;} }
function setSession(s){ sessionStorage.setItem('sb_s', JSON.stringify(s)); }
function clearSession(){ sessionStorage.removeItem('sb_s'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function doLogin(){
  const username = document.getElementById('loginUser').value.trim().toLowerCase();
  const password = document.getElementById('loginPass').value;
  const errEl    = document.getElementById('loginErr');
  const btn      = document.getElementById('loginBtn');
  errEl.style.display='none';
  btn.disabled=true; btn.innerHTML='<span class="spinner"></span> Verificando...';

  try {
    const user = await sb('GET','users',{
      filter:`username=eq.${encodeURIComponent(username)}&password=eq.${encodeURIComponent(password)}`,
      single:true
    });

    if(!user){ errEl.style.display='block'; btn.disabled=false; btn.textContent='â–¶ ENTRAR'; return; }

    session = {username:user.username, name:user.name, role:user.role};
    setSession(session);

    // Both roles go to the app â€” admins get the âš™ Admin button
    showScreen('appScreen');
    await initApp();
  } catch(e) {
    errEl.textContent='Error de conexiÃ³n. Verifica las credenciales de Supabase.';
    errEl.style.display='block';
  }
  btn.disabled=false; btn.textContent='â–¶ ENTRAR';
}

function doLogout(){
  clearSession(); session=null; appState={};
  document.getElementById('loginUser').value='';
  document.getElementById('loginPass').value='';
  showScreen('loginScreen');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadUsers(){
  const tbody = document.getElementById('usersBody');
  tbody.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:1rem;"><span class="spinner"></span> Cargando...</td></tr>';
  try {
    const users = await sb('GET','users',{select:'*'}) || [];
    const progList = await sb('GET','progress',{select:'username,xp_total,streak'}) || [];
    const progMap = Object.fromEntries(progList.map(p=>[p.username,p]));

    // Count how many admins exist total
    const adminCount = users.filter(u=>u.role==='admin').length;

    tbody.innerHTML = users.map(u=>{
      const p = progMap[u.username]||{xp_total:0,streak:0};
      // "admin" default can be deleted only if there's at least one other admin
      const isDefaultAdmin = u.username==='admin';
      const canDelete = !isDefaultAdmin || adminCount > 1;
      return `<tr>
        <td><code>${u.username}</code></td>
        <td>${u.name}</td>
        <td><span class="role-badge role-${u.role}">${u.role==='admin'?'Admin':'Alumno'}</span></td>
        <td><span class="stat-pill">${p.xp_total||0} XP</span></td>
        <td>${p.streak||0} dÃ­as ğŸ”¥</td>
        <td>${canDelete
          ?`<button class="btn sm danger" onclick="deleteUser('${u.username}')">Eliminar</button>`
          :`<span style="color:var(--muted);font-size:.58rem;">Crea otro admin primero</span>`}
        </td>
      </tr>`;
    }).join('');
  } catch(e) {
    tbody.innerHTML='<tr><td colspan="6" style="color:var(--red);padding:.8rem;">Error al cargar.</td></tr>';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â–¼â–¼â–¼  CONTRASEÃ‘A MAESTRA PARA CREAR ADMINS  â–¼â–¼â–¼
   CÃ¡mbiala por una que solo tÃº sepas
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MASTER_PASSWORD = 'CambiameAhora2024!';
/* â–²â–²â–² FIN â–²â–²â–² */

function toggleMasterField(){
  const role = document.getElementById('newRole').value;
  document.getElementById('masterField').style.display = role==='admin' ? 'block' : 'none';
  if(role!=='admin') document.getElementById('masterPass').value='';
}

async function createUser(){
  const username = document.getElementById('newUser').value.trim().toLowerCase().replace(/\s+/g,'');
  const name     = document.getElementById('newName').value.trim();
  const password = document.getElementById('newPass').value;
  const role     = document.getElementById('newRole').value;
  const errEl    = document.getElementById('addErr');
  const okEl     = document.getElementById('addOk');
  errEl.style.display='none'; okEl.style.display='none';

  if(!username||!name||!password){ errEl.textContent='Completa todos los campos.'; errEl.style.display='block'; return; }
  if(password.length<4){ errEl.textContent='ContraseÃ±a mÃ­nimo 4 caracteres.'; errEl.style.display='block'; return; }

  // Verificar contraseÃ±a maestra al crear admin
  if(role==='admin'){
    const master = document.getElementById('masterPass').value;
    if(master !== MASTER_PASSWORD){
      errEl.textContent='ContraseÃ±a maestra incorrecta.';
      errEl.style.display='block'; return;
    }
  }

  try {
    const existing = await sb('GET','users',{filter:`username=eq.${encodeURIComponent(username)}`,single:true});
    if(existing){ errEl.textContent='Ese usuario ya existe.'; errEl.style.display='block'; return; }
    await sbUpsert('users',{username,name,password,role});
    document.getElementById('newUser').value='';
    document.getElementById('newName').value='';
    document.getElementById('newPass').value='';
    document.getElementById('masterPass').value='';
    document.getElementById('newRole').value='user';
    document.getElementById('masterField').style.display='none';
    okEl.textContent=`âœ… Usuario "${username}" creado.`;
    okEl.style.display='block';
    showToast(`âœ… "${username}" creado`);
    loadUsers();
  } catch(e) {
    errEl.textContent='Error al crear usuario.';
    errEl.style.display='block';
  }
}

async function deleteUser(username){
  if(!confirm(`Â¿Eliminar a "${username}" y todo su progreso?`)) return;
  try {
    await sb('DELETE','progress',{filter:`username=eq.${encodeURIComponent(username)}`});
    await sb('DELETE','users',   {filter:`username=eq.${encodeURIComponent(username)}`});
    showToast(`ğŸ—‘ "${username}" eliminado`);
    loadUsers();
  } catch(e){ showToast('Error al eliminar.'); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function initApp(){
  document.getElementById('welcomeUser').textContent = session.name;
  document.getElementById('adminBtn').style.display  = session.role==='admin'?'inline-flex':'none';

  try {
    const row = await sb('GET','progress',{filter:`username=eq.${encodeURIComponent(session.username)}`,single:true});
    if(row){
      appState = {
        xp_total:        row.xp_total        || 0,
        streak:          row.streak          || 0,
        exercises_today: row.exercises_today || 0,
        completed_today: row.completed_today || [],
        xp_today:        row.xp_today        || 0,
        last_day:        row.last_day        || '',
        log:             row.log             || [],
        clicks:          row.clicks          || 0,
        notes:           row.notes           || '',
      };
    } else {
      appState = emptyState();
    }
  } catch(e){ appState = emptyState(); }

  document.getElementById('notesInput').value = appState.notes || '';
  checkDay();
  activeSubj = SUBJECTS[0].id;
  render();
  loadLeaderboard();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SAVE (debounced 2s)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function scheduleSave(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(async()=>{
    if(!session) return;
    try {
      await sbUpsert('progress',{
        username:        session.username,
        xp_total:        appState.xp_total,
        streak:          appState.streak,
        exercises_today: appState.exercises_today,
        completed_today: appState.completed_today,
        xp_today:        appState.xp_today,
        last_day:        appState.last_day,
        log:             appState.log,
        clicks:          appState.clicks,
        notes:           appState.notes,
        updated_at:      new Date().toISOString(),
      });
    } catch(e){ console.error('save error',e); }
  }, 2000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DAILY CHECK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function checkDay(){
  const today = new Date().toDateString();
  if(appState.last_day !== today){
    const yday=new Date(); yday.setDate(yday.getDate()-1);
    const had = (appState.completed_today||[]).length>0 || (appState.exercises_today||0)>0;
    if(appState.last_day===yday.toDateString()&&had){
      appState.streak++; addLog(`>>> Racha: ${appState.streak} dÃ­as ğŸ”¥`,'evt');
    } else if(appState.last_day&&!had){
      appState.streak=0; addLog('Racha rota. Â¡MaÃ±ana es otro dÃ­a!','err');
    }
    appState.completed_today=[]; appState.exercises_today=0; appState.xp_today=0;
    appState.last_day=today; scheduleSave();
  }
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PET SHAPES â€” one per level
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PET_SHAPES = {
  // Nivel 1: bean â€” estudiante dormido con cuaderno
  bean: (c) => `
    <ellipse cx="82" cy="155" rx="32" ry="5" fill="rgba(${c},0.08)"/>
    <rect x="32" y="82" width="101" height="68" rx="6" fill="#060e18" stroke="#38bdf8" stroke-width="0.6" stroke-opacity="0.3"/>
    <rect x="30" y="82" width="7" height="68" rx="2" fill="#0a1825"/>
    ${[90,102,114,126,138].map(y=>`<circle cx="33" cy="${y}" r="2.5" fill="#1a3050" stroke="#38bdf8" stroke-width="0.7" opacity="0.6"/>`).join('')}
    ${[96,106,116,126,136,146].map(y=>`<line x1="44" y1="${y}" x2="126" y2="${y}" stroke="#0f2035" stroke-width="1"/>`).join('')}
    <text x="47" y="95"  font-family="monospace" font-size="5.5" fill="#38bdf8" opacity="0.7">x=(-bÂ±âˆšD)/2a</text>
    <text x="47" y="105" font-family="monospace" font-size="5.5" fill="#facc15" opacity="0.6">F=ma</text>
    <text x="47" y="115" font-family="monospace" font-size="5.5" fill="#4ade80" opacity="0.55">E=mcÂ²</text>
    <ellipse cx="82" cy="53" rx="31" ry="27" fill="#060e18" stroke="#38bdf8" stroke-width="0.5" stroke-opacity="0.2"/>
    <ellipse cx="69" cy="51" rx="9" ry="9" fill="#030810"/>
    <ellipse cx="69" cy="51" rx="7" ry="7" fill="#38bdf8" opacity="0.75"/>
    <ellipse cx="67" cy="49" rx="2.5" ry="2.5" fill="white" opacity="0.6"/>
    <ellipse cx="69" cy="51" rx="3.5" ry="3.5" fill="#030810" opacity="0.5"/>
    <ellipse cx="95" cy="51" rx="9" ry="9" fill="#030810"/>
    <ellipse cx="95" cy="51" rx="7" ry="7" fill="#38bdf8" opacity="0.75"/>
    <ellipse cx="93" cy="49" rx="2.5" ry="2.5" fill="white" opacity="0.6"/>
    <ellipse cx="95" cy="51" rx="3.5" ry="3.5" fill="#030810" opacity="0.5"/>
    <rect x="59" y="42" width="20" height="16" rx="2" stroke="#facc15" stroke-width="1.2" fill="none" opacity="0.5"/>
    <rect x="85" y="42" width="20" height="16" rx="2" stroke="#facc15" stroke-width="1.2" fill="none" opacity="0.5"/>
    <line x1="79" y1="50" x2="85" y2="50" stroke="#facc15" stroke-width="1.2" opacity="0.5"/>
    <path d="M 76 66 Q 82 70 88 66" stroke="#38bdf8" stroke-width="1.5" fill="none" stroke-linecap="round" opacity="0.6"/>
    <polygon points="82,26 106,34 82,41 58,34" fill="#0d1e30" stroke="#38bdf8" stroke-width="0.5" stroke-opacity="0.3"/>
    <line x1="106" y1="34" x2="111" y2="48" stroke="#facc15" stroke-width="1.3"/>
    <circle cx="111" cy="50" r="2" fill="#facc15"/>
    <g transform="translate(30,92) rotate(-16)"><rect width="5" height="24" rx="1" fill="#f97316" opacity="0.8"/><polygon points="0,24 5,24 2.5,30" fill="#e06010"/></g>
    <g transform="translate(121,92) rotate(18)"><rect width="6" height="28" rx="1" fill="#facc15" opacity="0.8"/><line x1="1" y1="7" x2="4" y2="7" stroke="#0a1825" stroke-width="0.8"/><line x1="1" y1="14" x2="4" y2="14" stroke="#0a1825" stroke-width="0.8"/><line x1="1" y1="21" x2="4" y2="21" stroke="#0a1825" stroke-width="0.8"/></g>
    <ellipse cx="67" cy="148" rx="10" ry="5" fill="#060e18"/>
    <ellipse cx="97" cy="148" rx="10" ry="5" fill="#060e18"/>`,

  // Nivel 2: round â€” igual pero con expresiÃ³n mÃ¡s segura
  round: (c) => `
    <ellipse cx="82" cy="155" rx="34" ry="5.5" fill="rgba(${c},0.09)"/>
    <rect x="30" y="80" width="105" height="70" rx="7" fill="#070f1c" stroke="#60d0fa" stroke-width="0.8" stroke-opacity="0.4"/>
    <rect x="28" y="80" width="8" height="70" rx="2" fill="#0a1825"/>
    ${[90,102,114,126,138].map(y=>`<circle cx="32" cy="${y}" r="3" fill="#1a3050" stroke="#60d0fa" stroke-width="0.8" opacity="0.7"/>`).join('')}
    ${[95,105,115,125,135,145].map(y=>`<line x1="44" y1="${y}" x2="128" y2="${y}" stroke="#0f2035" stroke-width="1.1"/>`).join('')}
    <text x="46" y="93"  font-family="monospace" font-size="5.5" fill="#60d0fa" opacity="0.8">x=(-bÂ±âˆšD)/2a</text>
    <text x="46" y="103" font-family="monospace" font-size="5.5" fill="#facc15" opacity="0.7">F=GÂ·mâ‚mâ‚‚/rÂ²</text>
    <text x="46" y="113" font-family="monospace" font-size="5.5" fill="#4ade80" opacity="0.65">vÂ²=vâ‚€Â²+2aÎ”x</text>
    <text x="46" y="123" font-family="monospace" font-size="5.5" fill="#f472b6" opacity="0.6">âˆ«e^(-xÂ²)dx</text>
    <ellipse cx="82" cy="50" rx="33" ry="30" fill="#060e18" stroke="#60d0fa" stroke-width="0.6" stroke-opacity="0.25"/>
    <ellipse cx="69" cy="49" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="69" cy="49" rx="8" ry="8" fill="#60d0fa" opacity="0.8"/>
    <ellipse cx="67" cy="47" rx="3" ry="3" fill="white" opacity="0.65"/>
    <ellipse cx="69" cy="49" rx="4" ry="4" fill="#030810" opacity="0.55"/>
    <ellipse cx="95" cy="49" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="95" cy="49" rx="8" ry="8" fill="#60d0fa" opacity="0.8"/>
    <ellipse cx="93" cy="47" rx="3" ry="3" fill="white" opacity="0.65"/>
    <ellipse cx="95" cy="49" rx="4" ry="4" fill="#030810" opacity="0.55"/>
    <rect x="58" y="40" width="22" height="18" rx="2" stroke="#60d0fa" stroke-width="1.4" fill="none" opacity="0.6"/>
    <rect x="84" y="40" width="22" height="18" rx="2" stroke="#60d0fa" stroke-width="1.4" fill="none" opacity="0.6"/>
    <line x1="80" y1="49" x2="84" y2="49" stroke="#60d0fa" stroke-width="1.4" opacity="0.6"/>
    <path d="M 74 64 Q 82 72 90 64" stroke="#60d0fa" stroke-width="2" fill="none" stroke-linecap="round" opacity="0.8"/>
    <polygon points="82,22 108,31 82,39 56,31" fill="#0d1e30" stroke="#60d0fa" stroke-width="0.5" stroke-opacity="0.4"/>
    <rect x="78" y="22" width="8" height="4" rx="1" fill="#0a1825"/>
    <line x1="108" y1="31" x2="113" y2="44" stroke="#facc15" stroke-width="1.5"/>
    <circle cx="113" cy="46" r="2.5" fill="#facc15"/>
    <g transform="translate(28,90) rotate(-18)"><rect width="5" height="26" rx="1" fill="#f97316" opacity="0.85"/><polygon points="0,26 5,26 2.5,32" fill="#e06010"/></g>
    <g transform="translate(120,90) rotate(20)"><rect width="6" height="30" rx="1" fill="#60d0fa" opacity="0.8"/><line x1="1" y1="6" x2="4" y2="6" stroke="#0a1825" stroke-width="0.8"/><line x1="1" y1="13" x2="4" y2="13" stroke="#0a1825" stroke-width="0.8"/><line x1="1" y1="20" x2="4" y2="20" stroke="#0a1825" stroke-width="0.8"/></g>
    <ellipse cx="66" cy="150" rx="11" ry="5.5" fill="#060e18"/>
    <ellipse cx="98" cy="150" rx="11" ry="5.5" fill="#060e18"/>`,

  // Nivel 3: book â€” cuerpo libro abierto
  book: (c) => `
    <ellipse cx="82" cy="157" rx="36" ry="5" fill="rgba(${c},0.1)"/>
    <rect x="25" y="82" width="52" height="68" rx="3" fill="#0a1020" stroke="#facc15" stroke-width="1" stroke-opacity="0.5"/>
    <rect x="82" y="82" width="52" height="68" rx="3" fill="#0a1020" stroke="#facc15" stroke-width="1" stroke-opacity="0.5"/>
    <rect x="76" y="80" width="12" height="72" rx="2" fill="#facc15" opacity="0.15"/>
    ${[92,102,112,122,132,142].map(y=>`<line x1="30" y1="${y}" x2="72" y2="${y}" stroke="#1a3050" stroke-width="0.9"/>`).join('')}
    ${[92,102,112,122,132,142].map(y=>`<line x1="87" y1="${y}" x2="129" y2="${y}" stroke="#1a3050" stroke-width="0.9"/>`).join('')}
    <text x="30" y="91"  font-family="monospace" font-size="5" fill="#facc15" opacity="0.8">x=(-bÂ±âˆšD)/2a</text>
    <text x="30" y="101" font-family="monospace" font-size="5" fill="#facc15" opacity="0.7">F=ma</text>
    <text x="30" y="111" font-family="monospace" font-size="5" fill="#facc15" opacity="0.65">E=mcÂ²</text>
    <text x="87" y="91"  font-family="monospace" font-size="5" fill="#facc15" opacity="0.8">âˆ«f(x)dx=F</text>
    <text x="87" y="101" font-family="monospace" font-size="5" fill="#facc15" opacity="0.7">PV=nRT</text>
    <text x="87" y="111" font-family="monospace" font-size="5" fill="#facc15" opacity="0.65">Î»=h/mv</text>
    <ellipse cx="82" cy="50" rx="33" ry="29" fill="#060e18" stroke="#facc15" stroke-width="0.7" stroke-opacity="0.3"/>
    <ellipse cx="69" cy="49" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="69" cy="49" rx="8" ry="8" fill="#facc15" opacity="0.75"/>
    <ellipse cx="67" cy="47" rx="3" ry="3" fill="white" opacity="0.65"/>
    <ellipse cx="69" cy="49" rx="4" ry="4" fill="#030810" opacity="0.6"/>
    <ellipse cx="95" cy="49" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="95" cy="49" rx="8" ry="8" fill="#facc15" opacity="0.75"/>
    <ellipse cx="93" cy="47" rx="3" ry="3" fill="white" opacity="0.65"/>
    <ellipse cx="95" cy="49" rx="4" ry="4" fill="#030810" opacity="0.6"/>
    <rect x="58" y="40" width="22" height="17" rx="2" stroke="#facc15" stroke-width="1.3" fill="none" opacity="0.7"/>
    <rect x="84" y="40" width="22" height="17" rx="2" stroke="#facc15" stroke-width="1.3" fill="none" opacity="0.7"/>
    <line x1="80" y1="49" x2="84" y2="49" stroke="#facc15" stroke-width="1.3" opacity="0.7"/>
    <path d="M 74 64 Q 82 73 90 64" stroke="#facc15" stroke-width="2" fill="none" stroke-linecap="round" opacity="0.85"/>
    <polygon points="82,20 110,30 82,39 54,30" fill="#1a2a0a" stroke="#facc15" stroke-width="1" stroke-opacity="0.6"/>
    <rect x="78" y="20" width="8" height="5" rx="1" fill="#facc15" opacity="0.4"/>
    <line x1="110" y1="30" x2="116" y2="46" stroke="#facc15" stroke-width="1.5"/>
    <circle cx="116" cy="48" r="3" fill="#facc15"/>
    <g transform="translate(24,92) rotate(-15)"><rect width="6" height="28" rx="1" fill="#f97316" opacity="0.85"/><polygon points="0,28 6,28 3,35" fill="#e06010"/></g>
    <g transform="translate(121,90) rotate(18)"><rect width="7" height="30" rx="1" fill="#facc15" opacity="0.8"/></g>
    <ellipse cx="66" cy="152" rx="12" ry="5" fill="#060e18"/>
    <ellipse cx="98" cy="152" rx="12" ry="5" fill="#060e18"/>`,

  // Nivel 4: star â€” cuerpo estrella
  star: (c) => `
    <ellipse cx="82" cy="157" rx="36" ry="5" fill="rgba(${c},0.12)"/>
    <polygon points="82,78 93,105 122,105 100,122 108,150 82,133 56,150 64,122 42,105 71,105" fill="#0d1520" stroke="#fb923c" stroke-width="1.2" stroke-opacity="0.7"/>
    <text x="58" y="110" font-family="monospace" font-size="5" fill="#fb923c" opacity="0.6">F=ma</text>
    <text x="58" y="120" font-family="monospace" font-size="5" fill="#fb923c" opacity="0.5">E=mcÂ²</text>
    <text x="58" y="130" font-family="monospace" font-size="5" fill="#fb923c" opacity="0.45">PV=nRT</text>
    <ellipse cx="82" cy="50" rx="33" ry="29" fill="#060e18" stroke="#fb923c" stroke-width="0.8" stroke-opacity="0.35"/>
    <ellipse cx="69" cy="49" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="69" cy="49" rx="8" ry="8" fill="#fb923c" opacity="0.85"/>
    <ellipse cx="67" cy="47" rx="3" ry="3" fill="white" opacity="0.7"/>
    <ellipse cx="69" cy="49" rx="4" ry="4" fill="#030810" opacity="0.6"/>
    <ellipse cx="95" cy="49" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="95" cy="49" rx="8" ry="8" fill="#fb923c" opacity="0.85"/>
    <ellipse cx="93" cy="47" rx="3" ry="3" fill="white" opacity="0.7"/>
    <ellipse cx="95" cy="49" rx="4" ry="4" fill="#030810" opacity="0.6"/>
    <rect x="58" y="40" width="22" height="17" rx="2" stroke="#fb923c" stroke-width="1.4" fill="none" opacity="0.7"/>
    <rect x="84" y="40" width="22" height="17" rx="2" stroke="#fb923c" stroke-width="1.4" fill="none" opacity="0.7"/>
    <line x1="80" y1="49" x2="84" y2="49" stroke="#fb923c" stroke-width="1.4" opacity="0.7"/>
    <path d="M 73 64 Q 82 74 91 64" stroke="#fb923c" stroke-width="2" fill="none" stroke-linecap="round"/>
    <polygon points="82,20 110,30 82,39 54,30" fill="#1a1005" stroke="#fb923c" stroke-width="1" stroke-opacity="0.7"/>
    <line x1="110" y1="30" x2="117" y2="46" stroke="#fb923c" stroke-width="1.8"/>
    <circle cx="117" cy="48" r="3.5" fill="#fb923c"/>`,

  // Nivel 5: wizard â€” cuerpo tÃºnica mago
  wizard: (c) => `
    <ellipse cx="82" cy="158" rx="40" ry="5.5" fill="rgba(${c},0.12)"/>
    <polygon points="82,78 50,155 114,155" fill="#0d0a20" stroke="#f472b6" stroke-width="1" stroke-opacity="0.6"/>
    <circle cx="68" cy="115" r="8" fill="#f472b6" opacity="0.12" stroke="#f472b6" stroke-width="0.8" stroke-opacity="0.4"/>
    <circle cx="96" cy="125" r="6" fill="#f472b6" opacity="0.1" stroke="#f472b6" stroke-width="0.8" stroke-opacity="0.3"/>
    <circle cx="78" cy="138" r="4" fill="#f472b6" opacity="0.15" stroke="#f472b6" stroke-width="0.7" stroke-opacity="0.5"/>
    <text x="58" y="118" font-family="monospace" font-size="4.5" fill="#f472b6" opacity="0.5">â˜… E=mcÂ²</text>
    <text x="62" y="130" font-family="monospace" font-size="4.5" fill="#f472b6" opacity="0.45">âˆ«âˆ</text>
    <polygon points="82,8 96,50 56,23 108,23 68,50" fill="#1a0520" stroke="#f472b6" stroke-width="1" stroke-opacity="0.7"/>
    <circle cx="82" cy="8" r="5" fill="#f472b6" opacity="0.6"/>
    <ellipse cx="82" cy="52" rx="33" ry="29" fill="#060e18" stroke="#f472b6" stroke-width="0.7" stroke-opacity="0.3"/>
    <ellipse cx="69" cy="51" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="69" cy="51" rx="8" ry="8" fill="#f472b6" opacity="0.85"/>
    <ellipse cx="67" cy="49" rx="3" ry="3" fill="white" opacity="0.7"/>
    <ellipse cx="69" cy="51" rx="4" ry="4" fill="#030810" opacity="0.55"/>
    <ellipse cx="95" cy="51" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="95" cy="51" rx="8" ry="8" fill="#f472b6" opacity="0.85"/>
    <ellipse cx="93" cy="49" rx="3" ry="3" fill="white" opacity="0.7"/>
    <ellipse cx="95" cy="51" rx="4" ry="4" fill="#030810" opacity="0.55"/>
    <rect x="58" y="42" width="22" height="17" rx="2" stroke="#f472b6" stroke-width="1.4" fill="none" opacity="0.7"/>
    <rect x="84" y="42" width="22" height="17" rx="2" stroke="#f472b6" stroke-width="1.4" fill="none" opacity="0.7"/>
    <line x1="80" y1="51" x2="84" y2="51" stroke="#f472b6" stroke-width="1.4" opacity="0.7"/>
    <path d="M 73 66 Q 82 76 91 66" stroke="#f472b6" stroke-width="2.2" fill="none" stroke-linecap="round"/>
    <line x1="34" y1="100" x2="50" y2="78" stroke="#f472b6" stroke-width="1.5" stroke-opacity="0.6"/>
    <circle cx="32" cy="103" r="4" fill="#f472b6" opacity="0.5"/>`,

  // Nivel 6: robot â€” cuerpo robot metÃ¡lico
  robot: (c) => `
    <ellipse cx="82" cy="158" rx="38" ry="5" fill="rgba(${c},0.12)"/>
    <rect x="40" y="85" width="84" height="65" rx="4" fill="#050e0a" stroke="#4ade80" stroke-width="1.2" stroke-opacity="0.6"/>
    <rect x="28" y="100" width="14" height="35" rx="3" fill="#050e0a" stroke="#4ade80" stroke-width="1" stroke-opacity="0.5"/>
    <rect x="122" y="100" width="14" height="35" rx="3" fill="#050e0a" stroke="#4ade80" stroke-width="1" stroke-opacity="0.5"/>
    <rect x="55" y="95" width="22" height="18" rx="2" fill="#0a2010" stroke="#4ade80" stroke-width="0.8" stroke-opacity="0.5"/>
    <rect x="87" y="95" width="22" height="18" rx="2" fill="#0a2010" stroke="#4ade80" stroke-width="0.8" stroke-opacity="0.5"/>
    <circle cx="66" cy="104" r="5" fill="#4ade80" opacity="0.4"/>
    <circle cx="66" cy="104" r="2" fill="#4ade80" opacity="0.9"/>
    <circle cx="98" cy="104" r="5" fill="#4ade80" opacity="0.4"/>
    <circle cx="98" cy="104" r="2" fill="#4ade80" opacity="0.9"/>
    <rect x="55" y="120" width="54" height="8" rx="2" fill="#0a2010" stroke="#4ade80" stroke-width="0.7" stroke-opacity="0.4"/>
    <rect x="57" y="122" width="10" height="4" rx="1" fill="#4ade80" opacity="0.6"/>
    <rect x="71" y="122" width="10" height="4" rx="1" fill="#facc15" opacity="0.4"/>
    <rect x="85" y="122" width="10" height="4" rx="1" fill="#f87171" opacity="0.4"/>
    <text x="50" y="143" font-family="monospace" font-size="4.5" fill="#4ade80" opacity="0.5">01001000 01001001</text>
    <ellipse cx="82" cy="50" rx="34" ry="30" fill="#050e0a" stroke="#4ade80" stroke-width="1.2" stroke-opacity="0.5"/>
    <rect x="50" y="23" width="64" height="55" rx="5" fill="#050e0a" stroke="#4ade80" stroke-width="1" stroke-opacity="0.4"/>
    <circle cx="69" cy="46" r="10" fill="#030810" stroke="#4ade80" stroke-width="0.8" stroke-opacity="0.5"/>
    <circle cx="69" cy="46" r="7" fill="#4ade80" opacity="0.2"/>
    <circle cx="69" cy="46" r="4" fill="#4ade80" opacity="0.8"/>
    <circle cx="67" cy="44" r="1.5" fill="white" opacity="0.8"/>
    <circle cx="95" cy="46" r="10" fill="#030810" stroke="#4ade80" stroke-width="0.8" stroke-opacity="0.5"/>
    <circle cx="95" cy="46" r="7" fill="#4ade80" opacity="0.2"/>
    <circle cx="95" cy="46" r="4" fill="#4ade80" opacity="0.8"/>
    <circle cx="93" cy="44" r="1.5" fill="white" opacity="0.8"/>
    <rect x="68" y="60" width="28" height="6" rx="1" fill="#0a2010" stroke="#4ade80" stroke-width="0.7" stroke-opacity="0.5"/>
    <rect x="70" y="62" width="6" height="2" rx="0.5" fill="#4ade80" opacity="0.7"/>
    <rect x="79" y="62" width="6" height="2" rx="0.5" fill="#4ade80" opacity="0.5"/>
    <rect x="88" y="62" width="6" height="2" rx="0.5" fill="#4ade80" opacity="0.3"/>
    <rect x="57" y="28" width="50" height="12" rx="2" fill="#0a2010" stroke="#4ade80" stroke-width="0.7" stroke-opacity="0.4"/>
    <text x="60" y="38" font-family="monospace" font-size="5" fill="#4ade80" opacity="0.7">STUDY-BIT v6</text>
    <line x1="82" y1="20" x2="82" y2="8" stroke="#4ade80" stroke-width="1.5"/>
    <circle cx="82" cy="6" r="4" fill="#4ade80" opacity="0.7"/>`,

  // Nivel 7: lightning â€” cuerpo rayo/energÃ­a
  lightning: (c) => `
    <ellipse cx="82" cy="158" rx="38" ry="5" fill="rgba(${c},0.15)"/>
    <polygon points="82,78 60,120 78,120 62,155 104,108 86,108 102,78" fill="#0d0820" stroke="#a78bfa" stroke-width="1.2" stroke-opacity="0.7"/>
    <polygon points="82,85 64,118 80,118 66,150 100,112 84,112 100,85" fill="#a78bfa" opacity="0.08"/>
    <line x1="45" y1="95" x2="35" y2="80" stroke="#a78bfa" stroke-width="1" stroke-opacity="0.4"/>
    <line x1="119" y1="100" x2="132" y2="88" stroke="#a78bfa" stroke-width="1" stroke-opacity="0.4"/>
    <line x1="42" y1="130" x2="30" y2="125" stroke="#a78bfa" stroke-width="0.8" stroke-opacity="0.3"/>
    <ellipse cx="82" cy="50" rx="33" ry="29" fill="#060818" stroke="#a78bfa" stroke-width="0.8" stroke-opacity="0.4"/>
    <ellipse cx="69" cy="49" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="69" cy="49" rx="8" ry="8" fill="#a78bfa" opacity="0.9"/>
    <ellipse cx="67" cy="47" rx="3" ry="3" fill="white" opacity="0.75"/>
    <ellipse cx="69" cy="49" rx="4" ry="4" fill="#030810" opacity="0.55"/>
    <ellipse cx="95" cy="49" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="95" cy="49" rx="8" ry="8" fill="#a78bfa" opacity="0.9"/>
    <ellipse cx="93" cy="47" rx="3" ry="3" fill="white" opacity="0.75"/>
    <ellipse cx="95" cy="49" rx="4" ry="4" fill="#030810" opacity="0.55"/>
    <rect x="58" y="40" width="22" height="17" rx="2" stroke="#a78bfa" stroke-width="1.4" fill="none" opacity="0.7"/>
    <rect x="84" y="40" width="22" height="17" rx="2" stroke="#a78bfa" stroke-width="1.4" fill="none" opacity="0.7"/>
    <line x1="80" y1="49" x2="84" y2="49" stroke="#a78bfa" stroke-width="1.4" opacity="0.7"/>
    <path d="M 72 64 Q 82 76 92 64" stroke="#a78bfa" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    <polygon points="82,12 96,38 60,22 104,22 68,38" fill="#1a0828" stroke="#a78bfa" stroke-width="1" stroke-opacity="0.7"/>
    <circle cx="82" cy="10" r="5" fill="#a78bfa" opacity="0.7"/>`,

  // Nivel 8: dna â€” hÃ©lice ADN
  dna: (c) => `
    <ellipse cx="82" cy="158" rx="38" ry="5" fill="rgba(${c},0.12)"/>
    <path d="M 55 80 C 100 95 65 115 110 130 C 65 145 100 155 55 155" stroke="#34d399" stroke-width="2" fill="none" stroke-opacity="0.7"/>
    <path d="M 109 80 C 64 95 99 115 54 130 C 99 145 64 155 109 155" stroke="#60d0fa" stroke-width="2" fill="none" stroke-opacity="0.7"/>
    ${[88,100,112,124,136,148].map((y,i)=>`<line x1="${55+Math.sin(i*0.8)*20}" y1="${y}" x2="${109-Math.sin(i*0.8)*20}" y2="${y}" stroke="${i%2===0?'#34d399':'#60d0fa'}" stroke-width="1.5" opacity="0.6"/>`).join('')}
    <ellipse cx="82" cy="50" rx="33" ry="29" fill="#060e18" stroke="#34d399" stroke-width="0.8" stroke-opacity="0.4"/>
    <ellipse cx="69" cy="49" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="69" cy="49" rx="8" ry="8" fill="#34d399" opacity="0.85"/>
    <ellipse cx="67" cy="47" rx="3" ry="3" fill="white" opacity="0.7"/>
    <ellipse cx="69" cy="49" rx="4" ry="4" fill="#030810" opacity="0.55"/>
    <ellipse cx="95" cy="49" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="95" cy="49" rx="8" ry="8" fill="#34d399" opacity="0.85"/>
    <ellipse cx="93" cy="47" rx="3" ry="3" fill="white" opacity="0.7"/>
    <ellipse cx="95" cy="49" rx="4" ry="4" fill="#030810" opacity="0.55"/>
    <rect x="58" y="40" width="22" height="17" rx="2" stroke="#34d399" stroke-width="1.4" fill="none" opacity="0.7"/>
    <rect x="84" y="40" width="22" height="17" rx="2" stroke="#34d399" stroke-width="1.4" fill="none" opacity="0.7"/>
    <line x1="80" y1="49" x2="84" y2="49" stroke="#34d399" stroke-width="1.4" opacity="0.7"/>
    <path d="M 72 64 Q 82 76 92 64" stroke="#34d399" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    <polygon points="82,20 108,30 82,39 56,30" fill="#081a10" stroke="#34d399" stroke-width="1" stroke-opacity="0.6"/>
    <circle cx="82" cy="8" r="6" fill="#34d399" opacity="0.5" stroke="#34d399" stroke-width="1"/>
    <text x="76" y="11" font-family="monospace" font-size="6" fill="white" opacity="0.9">G</text>`,

  // Nivel 9: god â€” semidiÃ³s con aura
  god: (c) => `
    <ellipse cx="82" cy="158" rx="45" ry="6" fill="rgba(${c},0.2)"/>
    <circle cx="82" cy="118" r="42" fill="none" stroke="#fbbf24" stroke-width="0.5" stroke-opacity="0.12"/>
    <circle cx="82" cy="118" r="36" fill="none" stroke="#fbbf24" stroke-width="0.5" stroke-opacity="0.18"/>
    ${Array.from({length:12},(_,i)=>{const a=i*30*Math.PI/180; return `<line x1="${82+Math.cos(a)*38}" y1="${118+Math.sin(a)*38}" x2="${82+Math.cos(a)*46}" y2="${118+Math.sin(a)*46}" stroke="#fbbf24" stroke-width="1" stroke-opacity="0.3"/>`;}).join('')}
    <polygon points="82,78 118,155 46,155" fill="#120a00" stroke="#fbbf24" stroke-width="1.2" stroke-opacity="0.65"/>
    <polygon points="82,85 114,152 50,152" fill="#fbbf24" opacity="0.04"/>
    <text x="60" y="120" font-family="monospace" font-size="5" fill="#fbbf24" opacity="0.5">âˆ = âˆ«â‚€^âˆ</text>
    <text x="62" y="133" font-family="monospace" font-size="5" fill="#fbbf24" opacity="0.4">Ï†=(1+âˆš5)/2</text>
    <ellipse cx="82" cy="50" rx="33" ry="29" fill="#060e18" stroke="#fbbf24" stroke-width="1" stroke-opacity="0.5"/>
    <ellipse cx="82" cy="20" rx="40" ry="6" fill="none" stroke="#fbbf24" stroke-width="1.5" stroke-opacity="0.6"/>
    <ellipse cx="69" cy="49" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="69" cy="49" rx="8" ry="8" fill="#fbbf24" opacity="0.9"/>
    <ellipse cx="67" cy="47" rx="3" ry="3" fill="white" opacity="0.8"/>
    <ellipse cx="69" cy="49" rx="4" ry="4" fill="#030810" opacity="0.5"/>
    <ellipse cx="95" cy="49" rx="10" ry="10" fill="#030810"/>
    <ellipse cx="95" cy="49" rx="8" ry="8" fill="#fbbf24" opacity="0.9"/>
    <ellipse cx="93" cy="47" rx="3" ry="3" fill="white" opacity="0.8"/>
    <ellipse cx="95" cy="49" rx="4" ry="4" fill="#030810" opacity="0.5"/>
    <rect x="58" y="40" width="22" height="17" rx="2" stroke="#fbbf24" stroke-width="1.5" fill="none" opacity="0.8"/>
    <rect x="84" y="40" width="22" height="17" rx="2" stroke="#fbbf24" stroke-width="1.5" fill="none" opacity="0.8"/>
    <line x1="80" y1="49" x2="84" y2="49" stroke="#fbbf24" stroke-width="1.5" opacity="0.8"/>
    <path d="M 71 64 Q 82 78 93 64" stroke="#fbbf24" stroke-width="2.5" fill="none" stroke-linecap="round"/>`,

  // Nivel 10: singularity â€” ser de luz pura
  singularity: (c) => `
    <ellipse cx="82" cy="158" rx="50" ry="6" fill="rgba(255,255,255,0.15)"/>
    ${Array.from({length:24},(_,i)=>{const a=i*15*Math.PI/180,r1=30,r2=55+Math.random()*10; return `<line x1="${82+Math.cos(a)*r1}" y1="${118+Math.sin(a)*r1}" x2="${82+Math.cos(a)*r2}" y2="${118+Math.sin(a)*r2}" stroke="white" stroke-width="${0.5+i%3*0.3}" stroke-opacity="${0.1+i%5*0.05}"/>`;}).join('')}
    <circle cx="82" cy="118" r="30" fill="none" stroke="white" stroke-width="0.5" stroke-opacity="0.15"/>
    <circle cx="82" cy="118" r="22" fill="none" stroke="white" stroke-width="0.5" stroke-opacity="0.2"/>
    <circle cx="82" cy="118" r="14" fill="white" opacity="0.04"/>
    <polygon points="82,78 104,118 82,158 60,118" fill="none" stroke="white" stroke-width="0.8" stroke-opacity="0.35"/>
    <polygon points="60,118 82,78 104,118 82,158" fill="white" opacity="0.03"/>
    <text x="55" y="112" font-family="monospace" font-size="4.5" fill="white" opacity="0.4">âˆ‡Â²Ïˆ+kÂ²Ïˆ=0</text>
    <text x="58" y="125" font-family="monospace" font-size="4.5" fill="white" opacity="0.35">GÎ¼Î½=8Ï€TÎ¼Î½</text>
    <ellipse cx="82" cy="50" rx="33" ry="29" fill="#080808" stroke="white" stroke-width="1" stroke-opacity="0.5"/>
    <circle cx="82" cy="50" r="33" fill="none" stroke="white" stroke-width="0.5" stroke-opacity="0.1"/>
    <ellipse cx="69" cy="49" rx="10" ry="10" fill="#050505"/>
    <ellipse cx="69" cy="49" rx="8" ry="8" fill="white" opacity="0.9"/>
    <ellipse cx="67" cy="47" rx="3" ry="3" fill="white" opacity="1"/>
    <ellipse cx="69" cy="49" rx="3" ry="3" fill="#050505" opacity="0.4"/>
    <ellipse cx="95" cy="49" rx="10" ry="10" fill="#050505"/>
    <ellipse cx="95" cy="49" rx="8" ry="8" fill="white" opacity="0.9"/>
    <ellipse cx="93" cy="47" rx="3" ry="3" fill="white" opacity="1"/>
    <ellipse cx="95" cy="49" rx="3" ry="3" fill="#050505" opacity="0.4"/>
    <rect x="58" y="40" width="22" height="17" rx="2" stroke="white" stroke-width="1.5" fill="none" opacity="0.7"/>
    <rect x="84" y="40" width="22" height="17" rx="2" stroke="white" stroke-width="1.5" fill="none" opacity="0.7"/>
    <line x1="80" y1="49" x2="84" y2="49" stroke="white" stroke-width="1.5" opacity="0.7"/>
    <path d="M 70 64 Q 82 80 94 64" stroke="white" stroke-width="3" fill="none" stroke-linecap="round"/>
    <circle cx="82" cy="20" r="12" fill="white" opacity="0.07" stroke="white" stroke-width="1" stroke-opacity="0.4"/>
    <circle cx="82" cy="20" r="6" fill="white" opacity="0.15"/>
    <circle cx="82" cy="20" r="2" fill="white" opacity="0.9"/>`,
};

function renderPet(lvlIdx){
  const lvl = LEVELS[lvlIdx];
  const shape = PET_SHAPES[lvl.shape] || PET_SHAPES.bean;
  // Convert hex color to rgb for rgba usage
  const hex = lvl.col.replace('#','');
  const r = parseInt(hex.substr(0,2),16);
  const g = parseInt(hex.substr(2,2),16);
  const b = parseInt(hex.substr(4,2),16);
  const rgb = `${r},${g},${b}`;

  const container = document.getElementById('petSvgContainer');
  container.innerHTML = `<svg class="pet-svg" viewBox="0 0 165 165" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:165px;height:165px;cursor:pointer;filter:drop-shadow(0 0 18px ${lvl.col}60);animation:float 4s ease-in-out infinite;transition:filter .3s;" onclick="petClick()">
    ${shape(rgb)}
  </svg>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEADERBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadLeaderboard(){
  const el = document.getElementById('lbContainer');
  if(!el) return;
  el.innerHTML = '<div class="lb-empty"><span class="spinner"></span> Cargando...</div>';
  try {
    const users    = await sb('GET','users',   {select:'username,name'}) || [];
    const progList = await sb('GET','progress',{select:'username,xp_total,streak'}) || [];
    const progMap  = Object.fromEntries(progList.map(p=>[p.username,p]));

    const ranked = users.map(u => ({
      username: u.username,
      name:     u.name,
      xp:       progMap[u.username]?.xp_total || 0,
      streak:   progMap[u.username]?.streak    || 0,
    })).sort((a,b) => b.xp - a.xp);

    if(!ranked.length){ el.innerHTML='<div class="lb-empty">No hay usuarios aÃºn.</div>'; return; }

    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    const posClass = ['gold','silver','bronze'];

    el.innerHTML = ranked.map((u,i) => {
      const li   = getLvlIdxFor(u.xp);
      const lvl  = LEVELS[li];
      const isMe = session && u.username === session.username;
      const initials = u.name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
      return `<div class="lb-row${isMe?' me':''}">
        <div class="lb-pos ${posClass[i]||'rest'}">${medals[i]||i+1}</div>
        <div class="lb-avatar" style="border-color:${lvl.col};color:${lvl.col};background:${lvl.col}15;">${initials}</div>
        <div class="lb-info">
          <span class="lb-name">${u.name}${isMe?' <span style="color:var(--accent);font-size:.55rem;">(tÃº)</span>':''}</span>
          <span class="lb-rank-name">${lvl.name}</span>
        </div>
        <div class="lb-xp">
          <span class="lb-xp-val" style="color:${lvl.col};">${u.xp.toLocaleString()} XP</span>
          <span class="lb-streak">${u.streak > 0 ? 'ğŸ”¥ '+u.streak+' dÃ­as':'-'}</span>
        </div>
      </div>`;
    }).join('');
  } catch(e){
    el.innerHTML = '<div class="lb-empty" style="color:var(--red);">Error al cargar el ranking.</div>';
  }
}

function getLvlIdxFor(xp){ for(let i=LEVELS.length-1;i>=0;i--) if(xp>=LEVELS[i].min) return i; return 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getLvlIdx(){ for(let i=LEVELS.length-1;i>=0;i--) if(appState.xp_total>=LEVELS[i].min) return i; return 0; }

function render(){
  const li=getLvlIdx(), lvl=LEVELS[li], next=LEVELS[Math.min(li+1,LEVELS.length-1)];
  const pct=li===LEVELS.length-1?100:Math.min(100,((appState.xp_total-lvl.min)/(next.min-lvl.min))*100);

  document.getElementById('petRank').textContent=`// rango: ${lvl.name} â€” nivel ${li+1}`;
  document.getElementById('xpFill').style.cssText=`width:${pct}%;background:linear-gradient(90deg,${lvl.col},${lvl.col}88);box-shadow:0 0 12px ${lvl.col}60;`;
  document.getElementById('xpRight').style.color=lvl.col;
  document.getElementById('xpRight').textContent=`${appState.xp_total} / ${next.min} XP`;
  document.getElementById('s-streak').textContent=appState.streak;
  document.getElementById('s-exercises').textContent=appState.exercises_today;
  document.getElementById('s-habits').textContent=(appState.completed_today||[]).length;
  document.getElementById('s-xp').textContent=appState.xp_total;
  document.getElementById('exCount').textContent=appState.exercises_today;
  document.getElementById('logXpHoy').textContent=`${appState.xp_today||0} XP hoy`;
  const ti=Math.min(Math.floor(appState.xp_total/280),THOUGHTS.length-1);
  document.getElementById('thoughtBubble').textContent=THOUGHTS[ti];
  renderPet(li);
  buildTabs(); renderSubjectBody(); renderLog();
}

function buildTabs(){
  document.getElementById('subjectTabs').innerHTML=SUBJECTS.map(s=>
    `<button class="stab ${s.id===activeSubj?'active':''}" data-s="${s.id}" onclick="switchSubject('${s.id}')">${s.label}</button>`
  ).join('');
}

function switchSubject(id){ activeSubj=id; buildTabs(); renderSubjectBody(); }

function renderSubjectBody(){
  const s=SUBJECTS.find(x=>x.id===activeSubj);
  const done=s.habits.filter(h=>(appState.completed_today||[]).includes(h.id));
  const xpE=done.reduce((a,h)=>a+h.xp,0);
  document.getElementById('subjectBody').innerHTML=`
    <div class="subject-header">
      <span class="subject-icon">${s.icon}</span>
      <span class="subject-name" style="color:${s.col}">${s.name}</span>
      <span class="subject-xp-today">${done.length}/${s.habits.length} Â· +${xpE} XP</span>
    </div>
    <div class="habits-grid">${s.habits.map(h=>{
      const d=(appState.completed_today||[]).includes(h.id);
      return `<div class="habit-item ${d?'done':''}" onclick="toggleHabit('${h.id}')">
        <div class="habit-cb">${d?'âœ“':''}</div>
        <div class="habit-body"><span class="habit-label">${h.label}</span><span class="habit-xp">+${h.xp} XP</span></div>
      </div>`;
    }).join('')}</div>`;
}

function renderLog(){
  if(!(appState.log||[]).length) return;
  document.getElementById('logContainer').innerHTML=appState.log.slice(-12).reverse().map(e=>
    `<div class="log-line"><span class="log-t">[ ${e.t} ]</span><span class="log-m ${e.cls||''}">${e.m}</span></div>`
  ).join('');
}

function addLog(m,cls=''){
  if(!appState.log) appState.log=[];
  const t=new Date().toLocaleTimeString('es',{hour:'2-digit',minute:'2-digit'});
  appState.log.push({t,m,cls}); if(appState.log.length>20) appState.log.shift();
}

function gainXP(amount){
  const oldLi=getLvlIdx();
  appState.xp_total+=amount; appState.xp_today=(appState.xp_today||0)+amount;
  const newLi=getLvlIdx();
  if(newLi>oldLi){
    addLog(`>>> Â¡NIVEL ${newLi+1}: ${LEVELS[newLi].name}!`,'evt');
    showToast(`ğŸ‰ Â¡Nivel ${newLi+1}: ${LEVELS[newLi].name}!`,3500);
    const w=document.getElementById('petWrap');
    w.classList.add('evolving'); setTimeout(()=>{ w.classList.remove('evolving'); loadLeaderboard(); },1400);
  }
}

function toggleHabit(id){
  const s=SUBJECTS.find(s=>s.habits.some(h=>h.id===id));
  const h=s?.habits.find(x=>x.id===id); if(!h) return;
  if(!appState.completed_today) appState.completed_today=[];
  if(appState.completed_today.includes(id)){
    appState.completed_today=appState.completed_today.filter(x=>x!==id);
    appState.xp_total=Math.max(0,appState.xp_total-h.xp);
    appState.xp_today=Math.max(0,(appState.xp_today||0)-h.xp);
    addLog(`[-] ${s.name}: ${h.label} (-${h.xp} XP)`);
    showToast(`-${h.xp} XP`);
  } else {
    appState.completed_today.push(id);
    gainXP(h.xp);
    addLog(`[+] ${s.name}: ${h.label} (+${h.xp} XP)`,'ok');
    showToast(`+${h.xp} XP â€” ${s.name}`);
  }
  scheduleSave(); render();
}

function addExercise(delta){
  appState.exercises_today=Math.max(0,(appState.exercises_today||0)+delta);
  if(delta>0){ gainXP(5); addLog('ğŸ“ Ejercicio resuelto (+5 XP)','ok'); showToast('+5 XP â€” Â¡ejercicio!'); }
  scheduleSave(); render();
}

function saveNote(){
  const txt=document.getElementById('notesInput').value.trim();
  if(!txt){ showToast('Escribe algo primero âœï¸'); return; }
  appState.notes=document.getElementById('notesInput').value;
  gainXP(10);
  addLog(`âœï¸ Apunte guardado (+10 XP):`,'ok');
  showToast('+10 XP â€” Â¡apunte guardado!');
  scheduleSave(); render();
}

function petClick(){
  appState.clicks=(appState.clicks||0)+1;
  const msg=CLICK_MSGS[appState.clicks%CLICK_MSGS.length];
  document.getElementById('thoughtBubble').textContent=msg;
  addLog(`>>> ${msg}`); scheduleSave(); renderLog();
}

function showToast(msg,dur=2500){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if(!CONFIGURED){
  showScreen('setupScreen');
} else {
  const s=getSession();
  if(s){
    session=s;
    showScreen('appScreen'); initApp();
  } else {
    showScreen('loginScreen');
  }
}
</script>
</body>
</html>
